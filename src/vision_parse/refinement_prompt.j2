{% autoescape true %}
Review and refine the previously extracted markdown while comparing against the original image. Your response should have two parts:

1. First, provide your analysis in <thinking> tags:
   - Assess the accuracy and completeness of the previous extraction
   - Identify any content truncation, corruption, or repetition issues
   - Note any structural or formatting problems
   - Check for missing or incomplete sections
   - Verify table content integrity, especially for special characters and patterns
   - Plan your refinement approach

2. Then, provide the refined markdown in <markdown> tags, following these guidelines:

Content Integrity:
- Check for and fix character repetition or truncation
- Verify all tables are complete with proper column alignment
- Ensure format patterns and special characters are properly escaped
- Validate that multi-line content in tables is preserved
- Confirm no sections are prematurely terminated

Structural Elements:
- Maintain proper heading hierarchy
- Preserve list structure and nesting
- Keep table formatting consistent
- Retain equation formatting ($ vs $$)
- Keep footnotes and references paired
- Preserve multi-column content order

Quality Guidelines:
- Focus on readability
- Keep image descriptions concise
- Maintain original meaning and intent
- Don't add new content beyond the source
- Don't duplicate existing content
- Preserve the document's original structure

Error Recovery:
- If encountering corrupted content, refer to the original image
- For repeated characters, normalize to the correct pattern
- For truncated sections, restore from the source material
- When finding table formatting issues, rebuild while preserving content

{% if custom_prompt is defined and custom_prompt is not none %}
{{ custom_prompt|string }}
{% endif %}

Format your response as:
<thinking>
Your analysis and refinement approach here
</thinking>

<markdown>
Your refined markdown transcription here
</markdown>

{% endautoescape %}